#!/bin/bash
## Description: Run post-install steps after `ddev drush site:install`.
## Usage: post-install
## ExecRaw: false

set -euo pipefail

echo "==> Setting site UUID to match config/sync ..."
SYNC_UUID=$(grep "^uuid:" /var/www/html/config/sync/system.site.yml | awk '{print $2}')
drush config:set system.site uuid "$SYNC_UUID" -y

echo "==> Deleting entities created by site:install that conflict with config:import ..."

drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE taxonomy_term_data;
TRUNCATE TABLE taxonomy_term_field_data;
TRUNCATE TABLE taxonomy_term_field_revision;
TRUNCATE TABLE taxonomy_term_revision;
TRUNCATE TABLE taxonomy_term__parent;
TRUNCATE TABLE taxonomy_term__field_group_type_icon;
TRUNCATE TABLE taxonomy_term__field_topic_type_icon;
TRUNCATE TABLE taxonomy_term_revision__parent;
TRUNCATE TABLE taxonomy_term_revision__field_group_type_icon;
TRUNCATE TABLE taxonomy_term_revision__field_topic_type_icon;
SET FOREIGN_KEY_CHECKS=1;
"

drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE profile;
TRUNCATE TABLE profile_revision;
SET FOREIGN_KEY_CHECKS=1;
"
# Also truncate all profile field tables dynamically
drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
$(drush sql:query "SHOW TABLES LIKE 'profile\_%'" 2>/dev/null | while IFS= read -r tbl; do echo "TRUNCATE TABLE \`$tbl\`;"; done)
SET FOREIGN_KEY_CHECKS=1;
" 2>/dev/null || true

drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE crop;
TRUNCATE TABLE crop_field_data;
TRUNCATE TABLE crop_field_revision;
TRUNCATE TABLE crop_revision;
SET FOREIGN_KEY_CHECKS=1;
"

drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE block_content;
TRUNCATE TABLE block_content_field_data;
TRUNCATE TABLE block_content_field_revision;
TRUNCATE TABLE block_content_revision;
SET FOREIGN_KEY_CHECKS=1;
"
# Also truncate block_content field tables dynamically
drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
$(drush sql:query "SHOW TABLES LIKE 'block_content\_\_\_%'" 2>/dev/null | while IFS= read -r tbl; do echo "TRUNCATE TABLE \`$tbl\`;"; done)
$(drush sql:query "SHOW TABLES LIKE 'block_content\_revision\_\_\_%'" 2>/dev/null | while IFS= read -r tbl; do echo "TRUNCATE TABLE \`$tbl\`;"; done)
SET FOREIGN_KEY_CHECKS=1;
" 2>/dev/null || true

drush sql:query "
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE search_api_item;
TRUNCATE TABLE search_api_task;
SET FOREIGN_KEY_CHECKS=1;
"

echo "==> Pre-creating field storages not installed by site:install ..."
drush php:eval "
\$missing = ['field.storage.activity.field_activity_entity', 'field.storage.group_content.field_grequest_message'];
foreach (\$missing as \$name) {
  if (!\Drupal::config(\$name)->isNew()) { echo 'Already exists: ' . \$name . PHP_EOL; continue; }
  \$file = '/var/www/html/config/sync/' . \$name . '.yml';
  if (!file_exists(\$file)) { echo 'Skipping (not in sync): ' . \$name . PHP_EOL; continue; }
  \$data = \Drupal\Core\Serialization\Yaml::decode(file_get_contents(\$file));
  unset(\$data['uuid'], \$data['_core']);
  \Drupal\field\Entity\FieldStorageConfig::create(\$data)->save();
  echo 'Created: ' . \$name . PHP_EOL;
}
"

echo "==> Fixing UUID mismatches for block_content types and language entity ..."
drush php:eval "
\$configs = [
  'block_content.type.basic',
  'block_content.type.hero_call_to_action_block',
  'block_content.type.platform_intro',
  'language.entity.en',
];
foreach (\$configs as \$name) {
  \$file = '/var/www/html/config/sync/' . \$name . '.yml';
  if (!file_exists(\$file)) continue;
  \$data = \Drupal\Core\Serialization\Yaml::decode(file_get_contents(\$file));
  \$active = \Drupal::configFactory()->getEditable(\$name);
  if (!\$active->isNew() && \$active->get('uuid') !== \$data['uuid']) {
    \$active->set('uuid', \$data['uuid'])->save();
    echo 'Fixed UUID: ' . \$name . PHP_EOL;
  }
}
"

echo "==> Importing configuration (first pass) ..."
drush cache:rebuild
drush config:import -y || true

echo "==> Importing configuration (second pass to catch ordering issues) ..."
drush config:import -y || true

echo "==> Rebuilding caches ..."
drush cache:rebuild

echo ""
echo "Post-install complete. Visit the site with: ddev launch"
